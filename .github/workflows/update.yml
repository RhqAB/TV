name: Auto Merge CricHD with My Playlist

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download CricHD Playlist
        run: |
          curl -L https://raw.githubusercontent.com/abusaeeidx/CricHd-playlists-Auto-Update-permanent/refs/heads/main/ALL.m3u -o crichd.m3u

      - name: Filter & Combine Playlists
        run: |
          echo "#EXTM3U" > temp_header.m3u8
          awk '/^#EXTINF/ {getline url; if ($0 !~ /Sky Sports [1-9](\\D|$)/) { print $0 ORS url }}' crichd.m3u > crichd_filtered.m3u
          awk 'BEGIN{print ""} /^#EXTINF/ {
            match($0, /tvg-logo="[^"]+"/, logo);
            match($0, /, *[^,]+$/, name);
            if (logo[0] && name[0]) {
              print "#EXTINF:-1 group-title=\"Sports Auto Update\" " logo[0] " , " name[1];
              getline url; print url;
            }
          }' crichd_filtered.m3u > crichd_final.m3u

          awk '!/group-title="Sports Auto Update"/ {print}' Github.m3u8 > Github_cleaned.m3u8

          awk '/group-title="News"/ {print; found=1; next} found && /^#EXTINF/ {print; next} !found {next} 1' Github_cleaned.m3u8 > top_part.m3u8
          awk '!/group-title="News"/ {print}' Github_cleaned.m3u8 > bottom_part.m3u8

          cat temp_header.m3u8 top_part.m3u8 crichd_final.m3u bottom_part.m3u8 > Github.m3u8

      - name: Commit and Push if Changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Github.m3u8
          git diff --cached --quiet || git commit -m "Updated CricHD section with proper group-title and filtered channels"
          git push
