name: Auto Merge CricHD with My Playlist

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download CricHD Playlist
        run: |
          curl -L https://raw.githubusercontent.com/abusaeeidx/CricHd-playlists-Auto-Update-permanent/refs/heads/main/ALL.m3u -o crichd.m3u

      - name: Filter & Combine Playlists
        run: |
          # Filter CricHD data and exclude Sky Sports 1-9, retain only URLs with #EXTINF data
          awk '/^#EXTINF/ {getline url; if ($0 !~ /Sky Sports [1-9](\\D|$)/) { print $0 ORS url }}' crichd.m3u > crichd_filtered.m3u
          
          # Extract #EXTINF data (group-title, tvg-logo, channel name) and URLs
          awk 'BEGIN{print ""} /^#EXTINF/ {
            match($0, /tvg-logo="[^"]+"/, logo);
            match($0, /, *([^,]+)$/ , name);
            match($0, /group-title="[^"]+"/, group);
            if (logo[0] && name[0] && group[0]) {
              print "#EXTINF:-1 " group[0] " " logo[0] " , " name[1];
              getline url; print url;
            }
          }' crichd_filtered.m3u > crichd_final.m3u

          # Remove old CricHD sections from the existing playlist
          awk '!/group-title="Sports Auto Update"/ {print}' Github.m3u8 > Github_cleaned.m3u8

          # Combine the cleaned playlist with the new CricHD content (including EXTINF and group-title)
          cat Github_cleaned.m3u8 crichd_final.m3u > Github.m3u8

      - name: Commit and Push if Changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Github.m3u8
          git diff --cached --quiet || git commit -m "Updated CricHD section with group-title and proper EXTINF data"
          git push
